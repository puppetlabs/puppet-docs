<!DOCTYPE html>
<html dir="ltr" lang="en-US">
  <head>
  	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  	<title>Documentation | Puppet Labs - Learning — Resource Ordering</title>
  	<meta name="description" content="The open source leader in data center automation">
  	<link rel="alternate" type="text/xml" title="Puppet Labs RSS 0.92 Feed" href="http://puppetlabs.com/feed/rss/">
  	<link rel="alternate" type="application/atom+xml" title="Puppet Labs Atom Feed" href="http://puppetlabs.com/feed/atom/">
  	<link rel="alternate" type="application/rss+xml" title="Puppet Labs RSS 2.0 Feed" href="http://puppetlabs.com/feed/">
  	<link rel="pingback" href="http://puppetlabs.com/xmlrpc.php">
    <link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://puppetlabs.com/xmlrpc.php?rsd" />
    <link rel='index' title='Puppet Labs' href='http://docs.puppetlabs.com' />

<!-- Google stats -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-1537572-5");
pageTracker._setDomainName(".puppetlabs.com");
pageTracker._trackPageview();
} catch(err) {}</script>
<!-- End Google stats -->


    <!-- FIXME: absolute paths -->

    <script type='text/javascript' src='/files/javascripts/html5.js'></script>
    <script type='text/javascript' src='/files/javascripts/jquery-1.3.2.min.js'></script>
    <script type='text/javascript' src='/files/javascripts/drop_down.js'></script>
    <script type='text/javascript' src='/files/javascripts/cufon-yui.js'></script>
    <script type='text/javascript' src='/files/fonts/Klavika_400-Klavika_600.font.js'></script>
    <script type='text/javascript' src='/files/javascripts/ampersands.js'></script>

    <!-- All in One SEO Pack 1.6.10.1 by Michael Torbert of Semper Fi Web Design[127,146] -->
    <meta name="keywords" content="Puppet, puppet labs, reductive labs, open source, system administrator, ruby, data center, automation, support" />
    <link rel="canonical" href="http://docs.puppetlabs.com" />
    <!-- /all in one seo pack -->
	
    <!-- FIXME: absolute paths -->

    <link rel="stylesheet" type="text/css" href="/files/stylesheets/style.css" media="screen"> 
    <link rel="stylesheet" type="text/css" href="/files/stylesheets/syntax.css" media="screen"> <!-- index -->

    <!--[if IE 7]>
	  <link rel="stylesheet" type="text/css" href="/files/stylesheets/ie_7.css" media="screen"> <!-- index -->
    <![endif]-->
  
    <!--[if IE 8]>
	    <link rel="stylesheet" type="text/css" href="/files/stylesheets/ie_8.css" media="screen"> <!-- index -->
    <![endif]-->		

  	<script type="text/javascript">
      Cufon.replace('h1, h2', { fontWeight: '600' });
  	</script>
</head>



        
  <body id="resources" class="docs">
  <style type="text/css">h1, h2{ visibility : hidden }</style>		
  <!--[if IE 8]>
    <style type="text/css">h1, h2{ visibility : visible }</style>
  <![endif]-->		

  	<header id="header">
      <div class="site-width">
    		<h1><a href="http://puppetlabs.com/"><span>Puppet Labs</span></a></h1>
        <a class="screen-reader-content" href="#content">Skip navigation</a>
        <nav>
    		<ul id="global-navigation">
          <li id="puppet-tab" class="with-submenu">
            <a href="http://www.puppetlabs.com/puppet/">
              <span>Puppet</span>

              <span class="drop-down-trigger"></span>
            </a>
            <ul>            
              <li>
                <ul>
                  <li class="page_item page-item-757"><a href="http://www.puppetlabs.com/puppet/introduction/" title="Introduction">Introduction</a></li>
<li class="page_item page-item-769"><a href="http://www.puppetlabs.com/puppet/requirements/" title="Requirements">Requirements</a></li>
<li class="page_item page-item-956"><a href="http://www.puppetlabs.com/puppet/solutions/" title="Solutions">Solutions</a></li>
<li class="page_item page-item-1159"><a href="http://www.puppetlabs.com/puppet/users/" title="Users">Users</a></li>

<li class="page_item page-item-2415"><a href="http://www.puppetlabs.com/puppet/what-customers-are-saying/" title="What Customers are Saying">What Customers are Saying</a></li>
                </ul>
              </li>
              <li>
                <ul>
                  <li class="page_item page-item-1977"><a href="http://forge.puppetlabs.com" title="Module Forge">Module Forge</a></li>
<li class="page_item page-item-751"><a href="http://www.puppetlabs.com/puppet/related-projects/dashboard/" title="Dashboard">Dashboard</a></li>
<li class="page_item page-item-753"><a href="http://www.puppetlabs.com/puppet/related-projects/facter/" title="Facter">Facter</a></li>

                </ul>
              </li>
            </ul>
          </li>
          <li id="services-tab" class="with-submenu">
            <a href="http://www.puppetlabs.com/services/">
              <span>Services</span>
              <span class="drop-down-trigger"></span>

            </a>
            <ul>
              <li class="page_item page-item-783"><a href="http://www.puppetlabs.com/services/overview/" title="Overview">Overview</a></li>
<li class="page_item page-item-839"><a href="http://www.puppetlabs.com/services/support/" title="Enterprise Support">Enterprise Support</a></li>
<li class="page_item page-item-845"><a href="http://www.puppetlabs.com/services/training-workshops/" title="On-Site Training &amp; Consulting">On-Site Training &amp; Consulting</a></li>
<li class="page_item page-item-849"><a href="/category/events/upcoming/" title="Events &amp; Public Training">Events &amp; Public Training</a></li>

<li class="page_item page-item-2424"><a href="http://www.puppetlabs.com/services/what-customers-are-saying/" title="What Customers are Saying">What Customers are Saying</a></li>
<li class="page_item page-item-851"><a href="http://www.puppetlabs.com/services/partners/" title="Partners">Partners</a></li>
<li class="page_item page-item-1037"><a href="/resources/customer-support" title="Customer Support">Customer Support</a></li>
            </ul>
          </li>
          <li id="resources-tab" class="with-submenu">
            <a href="http://www.puppetlabs.com/resources/">
              <span>Resources</span>

              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-1048"><a href="http://www.puppetlabs.com/resources/overview-2/" title="Overview">Overview</a></li>
<li class="page_item page-item-833"><a href="http://www.puppetlabs.com/resources/case-studies/" title="Case Studies">Case Studies</a></li>
<li class="page_item page-item-1052"><a href="http://www.puppetlabs.com/resources/customer-support/" title="Customer Support">Customer Support</a></li>
<li class="page_item page-item-1040"><a href="http://docs.puppetlabs.com" title="Documentation">Documentation</a></li>
<li class="page_item page-item-872"><a href="http://info.puppetlabs.com/register-download" title="Downloads">Downloads</a></li>

<li class="page_item page-item-1961"><a href="http://forge.puppetlabs.com" title="Module Forge">Module Forge</a></li>
<li class="page_item page-item-835"><a href="http://info.puppetlabs.com/request-whitepapers.html" title="White Papers">White Papers</a></li>
<li class="page_item page-item-1967"><a href="http://projects.puppetlabs.com/projects/puppet/wiki" title="Wiki">Wiki</a></li>
            </ul>

          </li>
          <li id="community-tab" class="with-submenu">
            <a href="http://www.puppetlabs.com/community/">
              <span>Community</span>

              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-2195"><a href="http://www.puppetlabs.com/community/overview/" title="Overview">Overview</a></li>
<li class="page_item page-item-2264"><a href="http://www.puppetlabs.com/community/puppet-camp/" title="Puppet Camp">Puppet Camp</a></li>
<li class="page_item page-item-2249"><a href="http://www.puppetlabs.com/community/user-groups-and-devops-groups/" title="User Groups &amp; DevOps Groups">User Groups &amp; DevOps Groups</a></li>
<li class="page_item page-item-2215"><a href="http://www.puppetlabs.com/community/presentations/" title="Presentations">Presentations</a></li>

<li class="page_item page-item-2217"><a href="http://www.puppetlabs.com/community/videos/" title="Videos">Videos</a></li>
            </ul>
          </li>

          <li id="company-tab" class="with-submenu">
            <a href="http://www.puppetlabs.com/company/">
              <span>Company</span>
              <span class="drop-down-trigger"></span>
            </a>

            <ul>
              <li class="page_item page-item-2316"><a href="http://www.puppetlabs.com/company/overview/" title="Overview">Overview</a></li>
<li class="page_item page-item-2179"><a href="http://www.puppetlabs.com/company/news/" title="News">News</a></li>
<li class="page_item page-item-1571"><a href="http://www.puppetlabs.com/company/jobs/" title="Jobs">Jobs</a></li>
<li class="page_item page-item-2313"><a href="http://www.puppetlabs.com/company/contact-us/" title="Contact Us">Contact Us</a></li>
            </ul>
          </li>
    		</ul>	   
          <div id="misc-navigation">

			  <ul>
				<li><a href="http://docs.puppetlabs.com">Documentation</a></li>
				<li><a href="http://puppetlabs.com/resources/customer-support/">Support</a></li>
				<li><a href="http://projects.puppetlabs.com/">Bug Tracker</a></li>
				<li><a href="http://puppetlabs.com/company/#contact">Contact Us</a></li>
				<li><a href="http://puppetlabs.com/resources/downloads" class="gateway">Download</a></li>
			  </ul>
			<form action="http://www.google.com/cse" id="cse-search-box">

			  <div>
				<input type="hidden" name="cx" value="017884045025332504017:1mnj-dlgfcc" />
				<input type="hidden" name="ie" value="UTF-8" />
				<input type="text" name="q" size="31" />
				<input type="submit" name="sa" class="searchbtn" value="Search" />
			  </div>
			</form>
			<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en"></script>

          </div>
      </nav>
    	</div>
    </header>  

      <section id="masthead">
        <div class="site-width">
          <h1>Docs: <span class="section-name">Learning — Resource Ordering</span></h1>
          <ul id="doc-navigation">
            <li><a href="/">Docs Home</a></li>
            <li class="with-submenu">
              <a href="#">
                <span>Quick Nav</span>
                <span class="drop-down-trigger"></span>
              </a>
               <!-- the following links can't be relative, unfortunately -->
               <!-- future: add some JS to disable this if running from file:// -->
	            <dl>
	              <dt>Puppet Guides</dt>
                      <dd><a href="/index.html">Index</a></dd>
                  <dt>Puppet References</dt>
                      <dd><a href="/references/latest/type.html">Resource Types</a></dd>
                      <dd><a href="/references/latest/function.html">Functions</a></dd>
                      <dd><a href="/references/latest/metaparameter.html">Metaparameters</a></dd>
                      <dd><a href="/references/latest/configuration.html">Configuration</a></dd>
                  <dt>References By Version</dt>
                      <dd><a href="/references/2.6.6/">2.6.6</a></dd>
                      <dd><a href="/references/0.25.5/">0.25.5</a></dd> 
                      <dd><a href="/references/0.24.8/">0.24.8</a></dd>
                      <dd><a href="/references/">Other Versions</a></dd>
                  <dt>MCollective</dt>
                      <dd><a href="/mcollective/index.html">Index</a></dd>
                      <dd><a href="/mcollective/simplerpc/index.html">SimpleRPC</a></dd>
                      <dd><a href="/mcollective/roadmap/index.html">Roadmap</a></dd>
                      <dd><a href="/mcollective/releasenotes.html">Release Notes</a></dd>
                      <dd><a href="/mcollective/reference/index.html">References</a></dd>
	            </dl>
            </li>
            <li><a href="/contribute.html">Contribute</a></li>
          </ul>
        </div>
      </section>
    
      <section id="content">
        <div class="site-width">
          <div class="primary-secondary-content">
            <div class="primary-content">
              <h1 id="learning--resource-ordering">Learning — Resource Ordering</h1>

<p>You understand manifests and resource declarations; now learn about metaparameters, resource ordering, and one of the most useful patterns in Puppet.</p>

<hr />

<p>&larr; <a href="./manifests.html">Manifests</a> &mdash; <a href="./">Index</a> &mdash; TBA &rarr;</p>

<hr />

<h2 id="disorder">Disorder</h2>

<p>Let&rsquo;s look back on one of our manifests from the last page: </p>

<div class="highlight"><pre><code class="ruby">    <span class="c1"># /root/training-manifests/2.file.pp</span>
    
    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test2&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
        <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test3&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="p">,</span>
        <span class="n">target</span> <span class="o">=&gt;</span> <span class="s1">&#39;/tmp/test1&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">notify</span> <span class="p">{</span><span class="s2">&quot;I&#39;m notifying you.&quot;</span><span class="p">:}</span>
    <span class="n">notify</span> <span class="p">{</span><span class="s2">&quot;So am I!&quot;</span><span class="p">:}</span>
</code></pre>
</div>

<p>Although we wrote these declarations one after another, Puppet might sync them in any order: unlike with a procedural language, the physical order of resources in a manifest doesn&rsquo;t imply a logical order.</p>

<p>But some resources depend on other resources. So how do we tell Puppet which ones go first?</p>

<h2 id="metaparameters-resource-references-and-ordering">Metaparameters, Resource References, and Ordering</h2>

<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">notify</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="p">:</span>
        <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>Each resource type has its own set of attributes, but there&rsquo;s another set of attributes, called <a href="http://docs.puppetlabs.com/references/latest/metaparameter.html">metaparameters</a>, which can be used on any resource. (They&rsquo;re meta because they don&rsquo;t describe any feature of the resource that you could observe on the system after Puppet finishes; they only describe how Puppet should act.)</p>

<p>There are four metaparameters that let you arrange resources in order: <code>before</code>, <code>require</code>, <code>notify</code>, and <code>subscribe</code>. All of them accept a <strong>resource reference</strong> (or an array<sup id="fnref:array"><a href="#fn:array" rel="footnote">1</a></sup> of them). Resource references look like this:</p>

<div class="highlight"><pre><code class="ruby">    <span class="no">Type</span><span class="o">[</span><span class="s1">&#39;title&#39;</span><span class="o">]</span>
</code></pre>
</div>

<p>(Note the square brackets and capitalized resource type!)</p>

<h3 id="before-and-require">Before and Require</h3>

<p><code>before</code> and <code>require</code> make simple dependency relationships, where one resource must be synced before another. <code>before</code> is used in the earlier resource, and lists resources that depend on it; <code>require</code> is used in the later resource and lists the resources that it depends on. </p>

<p>These two metaparameters are just different ways of writing the same relationship &mdash; our example above could just as easily be written like this: </p>

<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
        <span class="n">before</span>  <span class="o">=&gt;</span> <span class="no">Notify</span><span class="o">[</span><span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="c1"># (See what I meant about symbolic titles being a good idea?)</span>
    <span class="p">}</span>
    
    <span class="n">notify</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="p">:}</span>
</code></pre>
</div>

<h3 id="notify-and-subscribe">Notify and Subscribe</h3>

<p>A few resource types<sup id="fnref:refreshtypes"><a href="#fn:refreshtypes" rel="footnote">2</a></sup> can be <strong>&ldquo;refreshed&rdquo;</strong> &mdash; that is, told to react to changes in their environment. For a service, this usually means restarting when a config file has been changed; for an <code>exec</code> resource, this could mean running its payload if any user accounts have been changed. (Note that refreshes are performed by Puppet, so they only occur during Puppet runs.) </p>

<p>The <code>notify</code> and <code>subscribe</code> metaparameters make dependency relationships the way <code>before</code> and <code>require</code> do, but they also make <strong>refresh relationships.</strong> Not only will the earlier resource in the pair get synced first, but if Puppet makes any changes to that resource, it will send a refresh event to the later resource, which will react accordingly. </p>

<h3 id="chaining">Chaining</h3>

<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">notify</span> <span class="p">{</span><span class="s1">&#39;after&#39;</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=&gt;</span> <span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="no">Notify</span><span class="o">[</span><span class="s1">&#39;after&#39;</span><span class="o">]</span>
</code></pre>
</div>

<p>There&rsquo;s one last way to declare relationships: chain resource references with the ordering (<code>-&gt;</code>) and notification (<code>~&gt;</code>; note the tilde) arrows. The arrows can point in either direction (<code>&lt;-</code> works too), and you should think of them as representing the flow of time: the resource at the blunt end of the arrow will be synced <em>before</em> the resource the arrow points at. </p>

<p>The example above yields the same dependency as the two examples before it. The benefit of this alternate syntax may not be obvious when we&rsquo;re working with simple examples, but it can be much more expressive and legible when we&rsquo;re working with resource collections. </p>

<h3 id="autorequire">Autorequire</h3>

<p>Some of Puppet&rsquo;s resource types will notice when an instance is related to other resources, and they&rsquo;ll set up automatic dependencies. The one you&rsquo;ll use most often is between files and their parent directories: if a given file and its parent directory are both being managed as resources, Puppet will make sure to sync the parent directory before the file. </p>

<p>Don&rsquo;t sweat much about the details of autorequiring; it&rsquo;s fairly conservative and should generally do the right thing without getting in your way. If you forget it&rsquo;s there and make explicit dependencies, your code will still work. </p>

<h2 id="summary">Summary</h2>

<p>So to sum up: whenever a resource depends on another resource, use the <code>before</code> or <code>require</code> metaparameter or chain the resources with <code>-&gt;</code>. Whenever a resource needs to refresh when another resource changes, use the <code>notify</code> or <code>subscribe</code> metaparameter or chain the resources with <code>~&gt;</code>. Some resources will autorequire other resources if they see them, which can save you some effort. </p>

<p>Hopefully that&rsquo;s all pretty clear! But even if it is, it&rsquo;s rather abstract &mdash; making sure a notify fires after a file is something of a &ldquo;hello world&rdquo; use case, and not very illustrative. Let&rsquo;s break something!</p>

<h2 id="example-sshd">Example: sshd</h2>

<p>You&rsquo;ve probably been using SSH and your favorite terminal app to interact with the Learning Puppet VM, so let&rsquo;s go straight for the most-annoying-case scenario: we&rsquo;ll pretend someone accidentally gave the wrong person (i.e., us) sudo privileges, and have you ruin root&rsquo;s ability to SSH to this box. We&rsquo;ll use Puppet to bust it and Puppet to fix it. </p>

<p>First, if you got the <code>ssh_authorized_key</code> exercise from the last page working, undo it. </p>

<pre><code># mv ~/.ssh/authorized_keys ~/old_ssh_authorized_keys
</code></pre>

<p>Now let&rsquo;s get a copy of the current sshd config file; going forward, we&rsquo;ll use our new copy as the canonical source for that file. </p>

<pre><code># cp /etc/ssh/sshd_config ~/learning-manifests/
</code></pre>

<p>Next, edit our new copy of the file. There&rsquo;s a line in there that says <code>PasswordAuthentication yes</code>; find it, and change the yes to a no. Then start writing some Puppet!</p>

<div class="highlight"><pre><code class="ruby">    <span class="c1"># /root/learning-manifests/break_ssh.pp</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
        <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span> 
        <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;/root/learning-manifests/sshd_config&#39;</span><span class="p">,</span>
        <span class="c1"># And yes, that&#39;s the first time we&#39;ve seen the &quot;source&quot; attribute.</span>
        <span class="c1"># It accepts absolute paths and puppet:/// URLs, about which more later.</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>Except that won&rsquo;t work! (Don&rsquo;t run it, and if you did, read this footnote.<sup id="fnref:inbetween"><a href="#fn:inbetween" rel="footnote">3</a></sup>) If we apply this manifest, the config file will change, but <code>sshd</code> will keep acting on the old config file until it restarts&hellip; and if it&rsquo;s only restarting when the system reboots, that could be years from now. </p>

<p>If we want the service to change its behavior as soon as we change our policy, we&rsquo;ll have to tell it to monitor the config file.</p>

<div class="highlight"><pre><code class="ruby">    <span class="c1"># /root/learning-manifests/break_ssh.pp, again</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
        <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span> 
        <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;/root/learning-manifests/sshd_config&#39;</span><span class="p">,</span>
    <span class="p">}</span>
        
    <span class="n">service</span> <span class="p">{</span> <span class="s1">&#39;sshd&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>     <span class="o">=&gt;</span> <span class="n">running</span><span class="p">,</span>
        <span class="n">enable</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> 
        <span class="n">hasrestart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
        <span class="n">hasstatus</span>  <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
        <span class="c1"># FYI, those last two attributes default to false, since</span>
        <span class="c1"># bad init scripts are more or less endemic.</span>
        <span class="n">subscribe</span>  <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>And that&rsquo;ll do it! Run that manifest with puppet apply, and after you log out, you won&rsquo;t be able to SSH into the VM again. <em>Victory.</em></p>

<p>To fix it, you&rsquo;ll have to log into the machine directly &mdash; use the screen provided by your virtualization app. Once you&rsquo;re there, you&rsquo;ll just have to edit <code>/root/learning-manifests/sshd_config</code> again to change the <code>PasswordAuthentication</code> setting and re-apply the same manifest; Puppet will replace <code>/etc/ssh/sshd_config</code> with the new version, restart the service, and re-enable remote password logins. (And you can put your SSH key back now, if you like.)</p>

<h2 id="packagefileservice">Package/File/Service</h2>

<p>The example we just saw was very close to a pattern you&rsquo;ll see constantly in production Puppet code, but it was missing a piece. Let&rsquo;s complete it:</p>

<div class="highlight"><pre><code class="ruby">    <span class="c1"># /root/learning-manifests/break_ssh.pp</span>
    <span class="n">package</span> <span class="p">{</span> <span class="s1">&#39;openssh-server&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
        <span class="n">before</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
        <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span> 
        <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;/root/learning-manifests/sshd_config&#39;</span><span class="p">,</span>
    <span class="p">}</span>
        
    <span class="n">service</span> <span class="p">{</span> <span class="s1">&#39;sshd&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>     <span class="o">=&gt;</span> <span class="n">running</span><span class="p">,</span>
        <span class="n">enable</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> 
        <span class="n">hasrestart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
        <span class="n">hasstatus</span>  <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
        <span class="n">subscribe</span>  <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>This is <strong>package/file/service,</strong> one of the most useful patterns in Puppet: the package resource makes sure the software is installed, the config file depends on the package resource, and the service subscribes to changes in the config file. </p>

<p>It&rsquo;s hard to understate the importance of this pattern; if this was all you knew how to do with Puppet, you could still do a fair amount of work. But we&rsquo;re not done yet. </p>

<h2 id="next">Next</h2>

<p>Well, actually we <em>are</em> done for the moment. But not for long! Come back soon to learn about variables, conditionals, and facts; after that, we&rsquo;ll move on to resource collections and modules. Send feedback to <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#102;&#097;&#113;&#064;&#112;&#117;&#112;&#112;&#101;&#116;&#108;&#097;&#098;&#115;&#046;&#099;&#111;&#109;">&#102;&#097;&#113;&#064;&#112;&#117;&#112;&#112;&#101;&#116;&#108;&#097;&#098;&#115;&#046;&#099;&#111;&#109;</a>, and thanks for reading. </p>
<div class="footnotes">
  <ol>
    <li id="fn:array">
      <p>Arrays in Puppet are made with square brackets and commas, so an array of resource references would <code>[ Notify['look'], Notify['like'], Notify['this'] ]</code>. <a href="#fnref:array" rev="footnote">&#8617;</a></p>
    </li>
    <li id="fn:refreshtypes">
      <p>Of the built-in types, only <code>exec</code>, <code>service</code>, and <code>mount</code> can be refreshed.<a href="#fnref:refreshtypes" rev="footnote">&#8617;</a></p>
    </li>
    <li id="fn:inbetween">
      <p>If you DID apply the incomplete manifest, something interesting happened: your machine is now in a half-rolled-out condition that puts the lie to what I said earlier about not having to worry about the system&rsquo;s current state. Since the config file is now in sync with its desired state, Puppet won&rsquo;t change it during the next run, which means applying the complete manifest won&rsquo;t cause the service to refresh until either the source file or the file on the system changes one more time. <br /><br />In practice, this isn&rsquo;t a huge problem, because only your development machines are likely to end up in this state; your production nodes won&rsquo;t have been given incomplete configurations. In the meantime, you have two options for cleaning up after applying an incomplete manifest: For a one-time fix, echo a bogus comment to the bottom of the file on the system (<code>echo "# ignoreme" &gt;&gt; /etc/ssh/sshd_config</code>), or for a more complete approach, make a comment in the source file that contains a version string, which you can update whenever you make significant changes to the associated manifest(s). Both of these approaches will mark the config file as out of sync, replace it during the Puppet run, and send the refresh event to the service. <a href="#fnref:inbetween" rev="footnote">&#8617;</a></p>
    </li>
  </ol>
</div>

            </div>
            <div class="secondary-content">
                  <div id="subCol">
                  <h3 class="chapter">Contents</h3>
                  <ol class="chapters">
                  <ol class="toc"><li><a href="#disorder">Disorder</a></li><li><a href="#metaparameters-resource-references-and-ordering">Metaparameters, Resource References, and Ordering</a></li><li><a href="#before-and-require">Before and Require</a></li><li><a href="#notify-and-subscribe">Notify and Subscribe</a></li><li><a href="#chaining">Chaining</a></li><li><a href="#autorequire">Autorequire</a></li><li><a href="#summary">Summary</a></li><li><a href="#example-sshd">Example: sshd</a></li><li><a href="#packagefileservice">Package/File/Service</a></li><li><a href="#next">Next</a></li></ol>
                  </ol>
                  </div>
            </div>
          </div>
        </div>
      </section>

		<footer id="footer">
      <div class="site-width">

        <div class="primary-secondary-content">
          <div class="primary-content">
            <section id="newsletter">
                 <h4>Puppet Labs is Hiring</h4>
                 <p><a href="http://www.puppetlabs.com/company/jobs/">Engineers, developers & consultants</a>
                  <p>  
		<h4>Newsletter</h4>

              <p>Stay up to date on all things puppet</p>
              
				<form class="lpeRegForm formNotEmpty" method="post" enctype="application/x-www-form-urlencoded" action="http://info.puppetlabs.com/index.php/leadCapture/save"; id="mktForm_1013" name="mktForm_1013">
				
				<label>Email Address:</label><span class='mktInput'><input class='mktFormText mktFormEmail' name="Email" id="Email" type='text' value="" maxlength='255'  /><span class='mktFormMsg'></span></span>
				
				<input id='mktFrmSubmit' type='submit' class='btn' style="width: auto; overflow: visible; padding-left: .25em; padding-right: .25em;" value='Subscribe' name='submitButton' onclick='formSubmit(document.getElementById("mktForm_1013")); return false;' />
				
				<input style='display: none;' id='mktFrmReset' type='reset' value='Clear' name='resetButton' onclick='formReset(document.getElementById("mktForm_1013")); return false;' />
	
				<span style="display:none;"><input type="text" name="_marketo_comments" value="" /></span>
				<input type="hidden" name="lpId" value="-1" />
				<input type="hidden" name="subId" value="100" />

				<input type="hidden" name="kw" value="" />
				<input type="hidden" name="cr" value="" />
				
				<input type="hidden" name="searchstr" value="" />
				<input type="hidden" name="lpurl" value="http://info.puppetlabs.com/testsubscription.html?cr={creative}&kw={keyword}"; />
				<input type="hidden" name="formid" value="1013" />
				<input type="hidden" name="returnURL" value="http://www.puppetlabs.com/misc/subscription-thank-you/"; />
				<input type="hidden" name="retURL" value="http://www.puppetlabs.com/misc/subscription-thank-you/"; />
				<input type="hidden" name="_mkt_disp" value="return" />
				<input type="hidden" name="_mkt_trk" value="" />

				</form>
				<script type="text/javascript" src="http://info.puppetlabs.com/js/mktFormSupport.js"></script>
				
				<script type="text/javascript">
				function formSubmit(elt) {
				return Mkto.formSubmit(elt);
				}
				function formReset(elt) {
				return Mkto.formReset(elt);
				}
				</script>
              

            </section>
            <section id="elsewhere">
              <h4>Get Involved</h4>
              <ul>

                <li class="chat"><a href="http://webchat.freenode.net/?channels=puppet" rel="external"><span class="indicator"></span><span>Chat with us on IRC</span></a></li>
		<li class="discussion"><a href="http://groups.google.com/group/puppet-dev" rel="external"><span class="indicator"></span><span>Join the Puppet Developer List</span></a></li>
                <li class="discussion"><a href="http://groups.google.com/group/puppet-users?pli=1" rel="external"><span class="indicator"></span><span>Join the Puppet User List</span></a></li>
                
                <li class="linkedin"><a href="http://www.linkedin.com/groups?about=&gid=696467&trk=anet_ug_grppro" rel="external"><span class="indicator"></span><span>Join the Puppet Users LinkedIn group</span></a></li>	

              </ul>
		<p>
		              		<h4>Follow us&#8230;</h4>

              		<ul class="followus"><li id='myprofiles_1'><a href='/feed/atom/' title='RSS'><img border='0' width='22' height='22' src='http://www.puppetlabs.com/wp-content/plugins/my-profiles/images/rss.png' alt='RSS'/></a></li> <li id='myprofiles_2'><a href='http://www.facebook.com/pages/Puppet-Labs/219089920711' title='FaceBook'><img border='0' width='22' height='22' src='http://www.puppetlabs.com/wp-content/plugins/my-profiles/images/facebook.png' alt='FaceBook'/></a></li> <li id='myprofiles_3'><a href='http://www.twitter.com/puppetlabs' title='Twitter'><img border='0' width='22' height='22' src='http://www.puppetlabs.com/wp-content/plugins/my-profiles/images/twitter.png' alt='Twitter'/></a></li> </ul>
              	</p>

            </section>
          </div>
          <div class="secondary-content">
            <section id="book-it">
              <h4>Get the book!</h4>

              <p>Written by James Turnbull, <a href="http://apress.com/book/view/1590599780" rel="nofollow">Pulling Strings with Puppet</a> is the first book to introduce the powerful Puppet system administration tool. </p>
              <a href="http://apress.com/book/view/1590599780" rel="nofollow"><img src="http://www.puppetlabs.com/images/book.png" /></a>
            </section>
          </div>
        </div>
      </div>
		</footer>

    <div id="copyright">
      <div class="site-width">
        &copy; 2010 <a href="http://www.puppetlabs.com/" title="Puppet Labs">Puppet Labs</a>
        <span class="vcard">
         <span class="org"></span>
         <a class="email" href="mailto:info@puppetlabs.com">info@puppetlabs.com</a>

          <span class="adr">
           <span class="street-address">411 NW Park Street</span>
           /
           <span class="locality">Portland</span>, 
           <span class="region">OR</span>
           <span class="postal-code">97209</span>

          </span>

         <span class="tel">1-877-575-9775</span>
        </span>          
      </div>
    </div>
    <script src="http://munchkin.marketo.net/munchkin.js" type="text/javascript"></script> <script>mktoMunchkin("307-QLA-991");</script> 
    
  	<script type="text/javascript">Cufon.now();</script>
  	<style type="text/css">h1, h2, .btn { visibility : visible; }</style>

	</body>
</html>        
